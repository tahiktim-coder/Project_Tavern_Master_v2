<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tavern Guild Master - Early Access</title>
    <!-- Importing a fantasy font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:ital,wght@0,400;0,700;1,400&family=MedievalSharp&display=swap');

        :root {
            /* Palette from Visual Style Guide */
            --bg-dark: #0d0806;
            --bg-card: #2a1f1a;
            --parchment: #f5e6d3;
            --parchment-dark: #d4b896;
            --gold: #FFD700;
            --gold-dark: #b8960a;
            --ink: #2c1810;
            --wood-dark: #3e2723;
            --wood-light: #5d4037;
            --green: #4CAF50;
            --red: #8b0000;

            --font-main: 'Lato', serif;
            --font-display: 'MedievalSharp', cursive;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-dark);
            color: var(--text-light);
            padding: 0;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            /* Prevent scroll on body, handle inside containers */
        }

        /* --- LAYOUT UTILITIES --- */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            /* Hidden by default */
            flex-direction: column;
            background: var(--bg-dark);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .screen.active {
            display: flex;
            opacity: 1;
            padding-top: 50px;
            /* Account for fixed HUD */
        }

        .header-bar {
            background: linear-gradient(to bottom, #1a1a1a, #0d0806);
            border-bottom: 2px solid var(--gold-dark);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--parchment);
            font-family: var(--font-display);
            font-size: 1.2rem;
            z-index: 100;
        }

        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        /* --- THEME: WOOD & PARCHMENT --- */
        .wood-bg {
            background:
                linear-gradient(90deg, rgba(62, 39, 35, 0.3) 1px, transparent 1px),
                linear-gradient(rgba(62, 39, 35, 0.3) 1px, transparent 1px),
                linear-gradient(135deg, #3e2723 0%, #4e342e 100%);
            background-size: 20px 20px, 20px 20px, 100% 100%;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8);
        }

        /* The Signature Quest Scroll Style */
        .quest-scroll {
            width: 280px;
            height: 380px;
            margin: 10px;
            position: relative;
            /* Parchment Texture */
            background:
                repeating-linear-gradient(0deg, rgba(139, 115, 85, 0.15) 0px, transparent 1px, transparent 2px),
                linear-gradient(to bottom, #e8d5ba 0%, #d4b896 50%, #e8d5ba 100%);
            color: var(--ink);
            border-left: 5px solid #6d4c41;
            border-right: 5px solid #6d4c41;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            padding: 40px 20px 60px 20px;
            box-sizing: border-box;
            font-family: var(--font-main);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            display: inline-block;
            vertical-align: top;
        }

        /* Rolled Edges using Pseudo-elements */
        .quest-scroll::before,
        .quest-scroll::after {
            content: "";
            position: absolute;
            left: -5px;
            right: -5px;
            height: 20px;
            background: linear-gradient(to right, #3e2723, #5d4037, #3e2723);
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .quest-scroll::before {
            top: -10px;
        }

        .quest-scroll::after {
            bottom: -10px;
        }

        /* Hide bottom scroll decoration in evening report to prevent overlap */
        #screen-evening .quest-scroll::after {
            display: none;
        }

        .quest-scroll:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6);
        }

        .quest-scroll h3 {
            font-family: var(--font-display);
            margin: 0 0 10px 0;
            border-bottom: 2px solid var(--ink);
            font-size: 1.4rem;
        }

        .rank-badge {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            position: absolute;
            top: 15px;
            right: 20px;
            border: 2px solid rgba(0, 0, 0, 0.3);
            font-family: var(--font-display);
        }

        /* --- BUTTONS --- */
        .btn {
            background: linear-gradient(to bottom, #8b0000, #500000);
            color: #ffecd2;
            font-family: var(--font-display);
            font-size: 1.1rem;
            border: 2px solid #a00;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            box-shadow: 0 4px 0 #300;
            text-transform: uppercase;
            text-shadow: 1px 1px 0 #000;
            transition: all 0.1s;
        }

        .btn:hover {
            filter: brightness(1.2);
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #300;
        }

        .btn:disabled {
            filter: grayscale(1);
            cursor: not-allowed;
        }

        .btn-green {
            background: linear-gradient(to bottom, #2e7d32, #1b5e20);
            border-color: #1b5e20;
            box-shadow: 0 4px 0 #003300;
        }

        /* --- SPECIFIC SCREENS --- */

        /* Town Hall Grid */
        #town-hall-board {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 40px;
        }

        /* Guild Hall Layout */
        .guild-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 100%;
            gap: 20px;
        }

        .guild-sidebar {
            background: var(--bg-card);
            border-right: 4px solid var(--wood-dark);
            padding: 20px;
            overflow-y: auto;
        }

        .guild-main {
            padding: 20px;
            overflow-y: auto;
        }

        /* Character Card (Simplified for now) */
        .char-card {
            background: var(--parchment);
            color: var(--ink);
            padding: 10px;
            border: 2px solid var(--wood-light);
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .char-portrait {
            width: 80px;
            height: 80px;
            background: #888;
            border: 2px solid var(--wood-dark);
        }

        /* Utility */
        .gold-display {
            color: var(--gold);
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <!-- PERSISTENT HUD (Always Visible During Gameplay) -->
    <div id="game-hud"
        style="display:none; position:fixed; top:0; left:0; right:0; z-index:500; background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0)); padding:10px 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; max-width:1200px; margin:0 auto;">
            <div style="display:flex; gap:30px; align-items:center;">
                <span style="font-family:var(--font-display); font-size:1.1rem; color:var(--parchment);">üìÖ Day <span
                        id="hud-day">1</span></span>
                <span style="font-family:var(--font-display); font-size:1.1rem; color:var(--gold);">üí∞ <span
                        id="hud-gold">350</span> G</span>
                <span style="font-family:var(--font-display); font-size:1rem; color:#aaa;">‚≠ê Town: <span
                        id="hud-rep">5</span></span>
                <span style="font-family:var(--font-display); font-size:1rem; color:#9370db;">üëë Crown: <span
                        id="hud-crown-rep">0</span></span>
            </div>
            <div>
                <button onclick="UI.openSettings()"
                    style="background:none; border:none; color:#888; cursor:pointer; font-size:1.2rem;">‚öôÔ∏è</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1100; align-items:center; justify-content:center;">
        <div class="quest-scroll" style="width:400px; height:auto;">
            <h2 style="font-family:var(--font-display);">‚öôÔ∏è Settings</h2>
            <br>
            <button class="btn" onclick="UI.returnToMainMenu()"
                style="width:100%; margin-bottom:10px; background:#555; border-color:#333;">üè† Main Menu</button>
            <button class="btn" onclick="UI.closeSettings()" style="width:100%;">Continue Playing</button>
        </div>
    </div>

    <!-- GAME OVER MODAL (Crown Rep = 0) -->
    <div id="game-over-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(30,0,0,0.95); z-index:2000; align-items:center; justify-content:center;">
        <div style="text-align:center; max-width:600px; padding:40px;">
            <h1
                style="font-family:var(--font-display); font-size:4rem; color:#8b0000; text-shadow:0 0 40px #500000; margin-bottom:20px;">
                üëë ROYAL DECREE
            </h1>
            <h2 style="font-family:var(--font-display); font-size:2rem; color:#ff4444; margin-bottom:30px;">
                LICENSE REVOKED
            </h2>
            <p style="color:#ccc; font-size:1.2rem; line-height:1.6; margin-bottom:40px;">
                By order of the Crown, your Guild Charter has been revoked.<br>
                Your reputation with the Royal Court has fallen beyond repair.<br>
                The guards escort you from the premises.
            </p>
            <div style="border-top:2px solid #500000; padding-top:30px;">
                <p style="color:#888; font-size:0.9rem; margin-bottom:20px;">
                    Days Survived: <span id="game-over-days" style="color:var(--gold);">0</span> |
                    Final Gold: <span id="game-over-gold" style="color:var(--gold);">0</span>G
                </p>
                <button class="btn" onclick="UI.returnToMainMenu()"
                    style="font-size:1.3rem; padding:15px 50px; background:linear-gradient(to bottom, #8b0000, #500000); border-color:#a00;">
                    Return to Main Menu
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN MENU (Entry Point) -->
    <div id="screen-main-menu" class="screen wood-bg active">
        <div
            style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
            <h1
                style="font-family: var(--font-display); font-size: 5rem; color: var(--gold); text-shadow: 0 0 30px black; margin-bottom: 20px;">
                TAVERN GUILD MASTER
            </h1>
            <p style="color: var(--parchment); font-size: 1.3rem; font-family: var(--font-main); margin-bottom: 60px;">
                Manage your adventurer's guild and send heroes on quests
            </p>

            <button class="btn btn-green" onclick="UI.startNewGame()"
                style="font-size:1.5rem; padding: 20px 60px; margin-bottom: 20px;">
                ‚öîÔ∏è New Game
            </button>
            <button class="btn" id="continue-btn" onclick="UI.continueGame()"
                style="font-size:1.3rem; padding: 15px 50px; background:#555; border-color:#333;" disabled>
                üìú Continue
            </button>
            <p id="save-status" style="color:#888; margin-top:15px; font-size:0.9rem;"></p>
        </div>
    </div>

    <!-- VISITOR EVENT SCREEN (Only shows when there's a morning visitor) -->
    <div id="screen-morning" class="screen wood-bg">
        <div
            style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
            <h1
                style="font-family: var(--font-display); font-size: 4rem; color: var(--gold); text-shadow: 0 0 20px black; margin-bottom: 0;">
                MORNING HAS BROKEN</h1>
            <h2 style="color: var(--parchment); font-family: var(--font-main);">Day <span id="morning-day">1</span></h2>
        </div>

        <!-- VISITOR MODAL (Overlay) -->
        <div id="visitor-modal"
            style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999; align-items:center; justify-content:center;">
            <div class="quest-scroll" style="width: 500px; height: auto; border: 4px solid var(--gold);">
                <h2 id="visitor-name">Visitor Name</h2>
                <div style="display:flex; gap:20px; margin-top:20px;">
                    <div style="width:100px; height:100px; background:#555; border:2px solid var(--ink);"></div>
                    <p id="visitor-text" style="flex:1; font-size:1.1rem;">Visitor dialogue text...</p>
                </div>
                <div style="margin-top:30px; display:flex; gap:10px; justify-content:flex-end;">
                    <button class="btn"
                        style="background: var(--gold-dark); border-color: var(--wood-dark); color: black;"
                        onclick="UI.handleVisitor(true)">Pay <span id="visitor-cost">20</span> G</button>
                    <button class="btn" style="background:#555; border-color:#333;"
                        onclick="UI.handleVisitor(false)">Refuse</button>
                </div>
            </div>
        </div>

        <!-- CHOICE EVENT MODAL (Reigns-style) -->
        <div id="choice-event-modal"
            style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center;">
            <div class="quest-scroll"
                style="width: 550px; height: auto; border: 4px solid var(--gold); max-height: 80vh; overflow-y: auto;">
                <h2 id="choice-event-title"
                    style="font-family: var(--font-display); color: var(--ink); border-bottom: 2px solid var(--ink); padding-bottom: 10px;">
                    Event Title
                </h2>
                <p id="choice-event-description"
                    style="font-size: 1.05rem; line-height: 1.5; margin: 15px 0; color: var(--ink);">
                    Event description text...
                </p>
                <div style="margin-top: 25px; display: flex; flex-direction: column; gap: 12px;">
                    <button id="choice-btn-0" class="btn"
                        style="width: 100%; padding: 15px; text-align: left; background: linear-gradient(to bottom, #4a7c4e, #3a5c3e); border: 2px solid #2d4a30; font-size: 1rem;"
                        onclick="UI.handleChoiceEvent(0)">
                        <span id="choice-text-0">Choice 1</span>
                    </button>
                    <button id="choice-btn-1" class="btn"
                        style="width: 100%; padding: 15px; text-align: left; background: linear-gradient(to bottom, #7c4a4a, #5c3a3a); border: 2px solid #4a2d2d; font-size: 1rem;"
                        onclick="UI.handleChoiceEvent(1)">
                        <span id="choice-text-1">Choice 2</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- QUEST PROGRESS MODAL (Interactive Story Quests) -->
    <div id="quest-progress-modal"
        style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(30,0,0,0.9); z-index:1001; align-items:center; justify-content:center;">
        <div class="quest-scroll"
            style="width: 600px; height: auto; border: 4px solid #8b0000; max-height: 85vh; overflow-y: auto; background: linear-gradient(to bottom, #f5e6d3 0%, #e8d5c0 50%, #d4c4b0 100%);">

            <!-- Blood Moon Header -->
            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #8b0000; padding-bottom: 10px; margin-bottom: 15px;">
                <div>
                    <span style="font-size: 1.5rem;">ü©∏</span>
                    <span id="quest-progress-title"
                        style="font-family: var(--font-display); font-size: 1.4rem; color: #8b0000;">
                        Quest Event
                    </span>
                </div>
                <div
                    style="background: #8b0000; color: #fff; padding: 5px 12px; border-radius: 4px; font-size: 0.85rem;">
                    DAY <span id="quest-progress-day">1</span> OF 3
                </div>
            </div>

            <!-- Hero Info -->
            <div
                style="display:flex; gap:10px; margin-bottom:15px; padding:10px; background:rgba(139,0,0,0.1); border-radius:4px;">
                <div style="width:50px; height:50px; background:#555; border:2px solid #8b0000;"></div>
                <div>
                    <div id="quest-progress-hero" style="font-weight:bold; color:var(--ink);">Hero Name</div>
                    <div id="quest-progress-quest" style="font-size:0.85rem; color:#666;">Quest Name</div>
                </div>
            </div>

            <!-- Description -->
            <p id="quest-progress-description"
                style="font-size: 1rem; line-height: 1.6; margin: 15px 0; color: var(--ink); font-style: italic;">
                Event description...
            </p>

            <!-- Choices -->
            <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                <button id="quest-progress-btn-0" class="btn"
                    style="width: 100%; padding: 14px; text-align: left; background: linear-gradient(to bottom, #5c3a3a, #4a2d2d); border: 2px solid #8b0000; font-size: 0.95rem; color: #ffecd2;"
                    onclick="UI.handleQuestProgress(0)">
                    <span id="quest-progress-choice-0">Choice 1</span>
                </button>
                <button id="quest-progress-btn-1" class="btn"
                    style="width: 100%; padding: 14px; text-align: left; background: linear-gradient(to bottom, #3a3a5c, #2d2d4a); border: 2px solid #4a4a8b; font-size: 0.95rem; color: #ffecd2;"
                    onclick="UI.handleQuestProgress(1)">
                    <span id="quest-progress-choice-1">Choice 2</span>
                </button>
            </div>
        </div>
    </div>

    <!-- SCREEN 2: TOWN HALL (Quest Board) -->
    <div id="screen-town" class="screen wood-bg">
        <div class="header-bar">
            <span>üèõÔ∏è TOWN HALL</span>
            <div>Claimed: <span id="claimed-count">0</span>/2</div>
            <button class="btn" onclick="UI.goToDesk()">Go to Desk ‚ûî</button>
        </div>
        <div class="main-content">
            <div id="town-hall-board">
                <!-- Quests injected here -->
            </div>
        </div>
    </div>

    <!-- SCREEN 2.5: DESK VIEW (Adventurer Queue) -->
    <div id="screen-desk" class="screen" style="background: var(--bg-dark);">
        <div class="header-bar">
            <span>üìã YOUR DESK</span>
            <div id="desk-queue-indicator">Waiting: <span id="desk-queue-count">0</span> adventurers</div>
            <button class="btn" onclick="UI.skipToRoster()" id="skip-to-roster-btn">Skip to Roster ‚ûî</button>
        </div>

        <div
            style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding-top:80px;">

            <!-- Speech Bubble (Random Greeting) -->
            <div id="desk-speech-bubble"
                style="max-width:400px; background:rgba(255,255,255,0.95); border-radius:8px; padding:10px 16px; margin-bottom:10px; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                <p id="desk-adventurer-greeting"
                    style="margin:0; font-size:0.9rem; font-style:italic; color:#2c1810; text-align:center;">"..."</p>
            </div>

            <!-- Adventurer Card - Compact design -->
            <div id="desk-adventurer-card" class="quest-scroll" style="width:400px; max-width:92%; padding:14px;">

                <!-- Row 1: Portrait + Name/Class -->
                <div style="display:flex; gap:12px;">
                    <div
                        style="width:64px; height:64px; background:#555; border:2px solid var(--wood-dark); flex-shrink:0;">
                    </div>
                    <div style="flex:1; min-width:0;">
                        <h2 id="desk-char-name"
                            style="font-family:var(--font-display); margin:0; font-size:1.1rem; line-height:1.2;"></h2>
                        <div style="color:#888; font-size:0.8rem; margin-top:2px;">
                            <span id="desk-char-class"></span> ‚Ä¢ <span id="desk-char-level"></span>
                        </div>
                        <div id="desk-char-traits" style="margin-top:5px;"></div>
                    </div>
                </div>

                <!-- Row 2: Visual Tells -->
                <div id="desk-visual-tells"
                    style="margin-top:8px; padding:5px 8px; background:rgba(0,0,0,0.15); border-radius:3px; font-style:italic; color:#eee; font-size:0.72rem; line-height:1.4;">
                </div>

                <!-- Row 3: Stats -->
                <div id="desk-char-stats" style="margin-top:8px; display:flex; gap:4px;"></div>

                <!-- Row 4: Buttons -->
                <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:6px;">
                    <button class="btn btn-green" onclick="UI.hireFromDesk('fulltime')"
                        style="padding:8px 6px; text-align:center;">
                        <div style="font-size:0.8rem;">‚úÖ FULL-TIME</div>
                        <div id="desk-cost-fulltime" style="font-size:1.05rem; font-weight:bold; margin:2px 0;">110G
                        </div>
                        <div style="font-size:0.6rem; opacity:0.9;">+<span id="desk-wage">20</span>G/day wage</div>
                    </button>
                    <button class="btn" onclick="UI.hireFromDesk('freelance')"
                        style="padding:8px 6px; background:var(--gold-dark); color:#000; text-align:center;">
                        <div style="font-size:0.8rem;">ü§ù FREELANCE</div>
                        <div id="desk-cost-freelance" style="font-size:1.05rem; font-weight:bold; margin:2px 0;">44G
                        </div>
                        <div style="font-size:0.6rem; opacity:0.8;">+50% quest cut</div>
                    </button>
                </div>
                <button class="btn" onclick="UI.rejectFromDesk()"
                    style="width:100%; margin-top:6px; padding:7px; background:#444; border-color:#333; font-size:0.8rem;">
                    ‚ùå REJECT ‚Üí Next
                </button>
            </div>

            <!-- No More Adventurers Message -->
            <div id="desk-empty-message" style="display:none; text-align:center; color:var(--parchment);">
                <h2 style="font-family:var(--font-display); color:var(--gold);">No More Visitors Today</h2>
                <p>The queue is empty. Head to your roster to manage quests.</p>
                <button class="btn btn-green" onclick="UI.skipToRoster()"
                    style="margin-top:20px; font-size:1.2rem; padding:15px 40px;">Go to Roster ‚ûî</button>
            </div>

            <!-- Queue Dots -->
            <div id="desk-queue-dots" style="margin-top:20px; display:flex; gap:8px;"></div>
        </div>
    </div>

    <!-- SCREEN 3: ROSTER VIEW (Quest Management) -->
    <div id="screen-guild" class="screen" style="background: var(--bg-dark);">
        <div class="header-bar">
            <span>üõ°Ô∏è ROSTER</span>
            <div class="gold-display" id="guild-gold">350 G</div>
            <button class="btn" onclick="UI.endDay()">End Day üåô</button>
        </div>

        <div class="guild-layout">
            <!-- Sidebar: Roster -->
            <div class="guild-sidebar">
                <h2
                    style="color:var(--gold); border-bottom:1px solid var(--wood-light); font-family:var(--font-display);">
                    Your Heroes</h2>
                <div id="guild-roster-list">
                    <!-- Roster items -->
                </div>

                <!-- Wall of the Fallen Memorial -->
                <div id="guild-memorial" style="margin-top: 20px; display: none;">
                    <h3
                        style="color:#8b0000; border-bottom:1px solid #4a2020; font-family:var(--font-display); font-size:0.9rem;">
                        üíÄ Wall of the Fallen
                    </h3>
                    <div id="guild-memorial-list" style="max-height: 200px; overflow-y: auto;">
                        <!-- Memorial entries -->
                    </div>
                </div>
            </div>

            <!-- Main: Quest Assignments -->
            <div class="guild-main">
                <h2 style="color:var(--parchment); font-family:var(--font-display);">Claimed Quests (Assignments)
                </h2>
                <div id="guild-quest-list" style="display:flex; flex-wrap:wrap;">
                    <!-- Claimed quests go here -->
                </div>
            </div>
        </div>
    </div>

    <!-- CHARACTER DETAIL MODAL -->
    <div id="character-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div class="quest-scroll" style="width: 600px; height: auto; max-height:80vh; overflow-y:auto; cursor:default;">
            <h2 id="char-modal-name" style="font-family: var(--font-display); border-bottom: 2px solid var(--ink);">
                Character Name</h2>
            <div style="display:flex; gap:15px; margin-top:15px;">
                <div style="width:100px; height:120px; background:#888; border:2px solid var(--wood-dark);"></div>
                <div style="flex:1;">
                    <p id="char-modal-class" style="margin:0; font-weight:bold;"></p>
                    <p id="char-modal-level" style="margin:5px 0; font-size:0.9rem;"></p>
                    <p id="char-modal-type" style="margin:0; font-size:0.85rem; color:#666;"></p>
                </div>
            </div>

            <h3 style="margin-top:20px; font-family:var(--font-display); font-size:1.1rem;">Stats</h3>
            <div id="char-modal-stats"></div>

            <h3 style="margin-top:15px; font-family:var(--font-display); font-size:1.1rem;">Traits</h3>
            <div id="char-modal-traits"></div>

            <button class="btn" onclick="UI.closeCharacterModal()"
                style="margin-top:20px; width:100%; background:linear-gradient(to bottom, #555, #333); border-color:#666;">Close</button>
        </div>
    </div>

    <!-- QUEST ASSIGNMENT MODAL -->
    <div id="assign-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div class="quest-scroll" style="width: 500px; height: auto; max-height:80vh; overflow-y:auto; cursor:default;">
            <h2 style="font-family: var(--font-display);">Assign Hero to Quest</h2>
            <p id="assign-quest-name" style="font-weight:bold; margin:10px 0;"></p>
            <hr style="border:0; border-bottom:1px solid #ccc; margin:15px 0;">
            <h3 style="font-size:1rem;">Select Hero:</h3>
            <div id="assign-hero-list"></div>
            <button class="btn" onclick="UI.closeAssignModal()"
                style="margin-top:15px; width:100%; background:#555; border-color:#333;">Cancel</button>
        </div>
    </div>

    <!-- SCREEN 4: EVENING REPORT -->
    <div id="screen-evening" class="screen wood-bg">
        <div class="header-bar">
            <span>üìú EVENING REPORT</span>
            <div class="gold-display" id="evening-gold"></div>
            <button class="btn btn-green" onclick="UI.startNextDay()">üí§ Rest Until Dawn</button>
        </div>
        <div class="main-content" style="display:flex; justify-content:center; padding-top:20px;">
            <div class="quest-scroll"
                style="width: 700px; height: auto; max-height:calc(100vh - 140px); overflow-y:auto; padding-bottom:40px;">
                <h3>üìú DAILY LEDGER</h3>
                <div id="evening-report-content" style="text-align:left; padding:10px;">
                    <!-- Report Details -->
                </div>
            </div>
        </div>
    </div>


    <!-- SCRIPTS -->
    <script src="data/classes.js"></script>
    <script src="data/traits.js"></script>
    <script src="data/quests.js"></script>
    <script src="data/items.js"></script>
    <script src="data/characters.js"></script>
    <script src="data/choice_events.js"></script>
    <script src="data/combat_pools.js"></script>
    <script src="data/injuries.js"></script>
    <script src="data/adventurer_dialogue.js"></script>

    <script src="src/utils/ContentLoader.js"></script>
    <script src="src/events/ChoiceEventSystem.js"></script>
    <script src="src/core/GameState.js"></script>
    <script src="src/core/QuestResolver.js"></script>
    <script src="src/ui/QuestMap.js"></script>
    <script src="src/narrative/NarrativeGenerator.js"></script>

    <script>
        const UI = {
            init() {
                window.ContentLoader.init().then(() => {
                    // Check if save exists
                    const hasSave = localStorage.getItem('TGM_Save') !== null;

                    // Show main menu
                    document.getElementById('screen-main-menu').classList.add('active');

                    // Enable "Continue" button if save exists
                    const continueBtn = document.getElementById('continue-btn');
                    const saveStatus = document.getElementById('save-status');

                    if (hasSave) {
                        continueBtn.disabled = false;
                        continueBtn.style.opacity = '1';

                        // Show save info
                        try {
                            const data = JSON.parse(localStorage.getItem('TGM_Save'));
                            saveStatus.innerText = `Saved Game: Day ${data.day}, ${data.gold}G`;
                        } catch (e) {
                            saveStatus.innerText = "Save found";
                        }
                    } else {
                        continueBtn.style.opacity = '0.5';
                        saveStatus.innerText = "No saved game found";
                    }
                }).catch(err => alert("Error: " + err));
            },

            startNewGame() {
                // Clear any existing save
                localStorage.removeItem('TGM_Save');

                // Reset GameState singleton properly
                GameState.resetInstance();

                // Hide menu
                document.getElementById('screen-main-menu').classList.remove('active');

                // Initialize fresh GameState
                window.GameState.init();
                this.syncScreen();
            },

            continueGame() {
                // Hide menu
                document.getElementById('screen-main-menu').classList.remove('active');

                // Load GameState
                window.GameState.init();
                this.syncScreen();
            },

            // --- NAVIGATION & PHASE CONTROL ---

            syncScreen() {
                // Hide all screens
                document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));

                const phase = window.GameState.phase;
                const isGameplay = phase !== 'MAIN_MENU';

                // Show/Hide HUD based on gameplay state
                document.getElementById('game-hud').style.display = isGameplay ? 'block' : 'none';

                // Update HUD values
                if (isGameplay) {
                    this.updateHUD();
                }

                // AUTO-PROCEED: If morning phase and no visitor event, check for choice events
                if (phase === 'MORNING' && !window.GameState.morningEvent) {
                    // Check for MORNING choice event before proceeding
                    if (this.checkForPhaseChoiceEvent('MORNING')) {
                        document.getElementById('screen-morning').classList.add('active');
                        document.getElementById('morning-day').innerText = window.GameState.day;
                        return; // Event modal shown, wait for player choice
                    }

                    window.GameState.enterTownHall();
                    document.getElementById('screen-town').classList.add('active');
                    this.renderTownHall();

                    // Check for TOWN_HALL choice event after rendering
                    this.checkForPhaseChoiceEvent('TOWN_HALL');
                    return;
                }

                // If morning WITH visitor event, show the morning screen + modal
                if (phase === 'MORNING') {
                    document.getElementById('screen-morning').classList.add('active');
                    document.getElementById('morning-day').innerText = window.GameState.day;

                    // Priority 1: Interactive quest progress events
                    if (window.GameState.activeQuestProgress) {
                        this.showQuestProgressModal(window.GameState.activeQuestProgress);
                    }
                    // Priority 2: Regular visitor events
                    else if (window.GameState.morningEvent) {
                        this.showVisitorModal(window.GameState.morningEvent);
                    }
                }
                else if (phase === 'TOWN_HALL') {
                    document.getElementById('screen-town').classList.add('active');
                    this.renderTownHall();

                    // Check for choice event on Town Hall entry
                    this.checkForPhaseChoiceEvent('TOWN_HALL');
                }
                else if (phase === 'DESK') {
                    document.getElementById('screen-desk').classList.add('active');
                    this.renderDesk();
                }
                else if (phase === 'GUILD_HALL') {
                    document.getElementById('screen-guild').classList.add('active');
                    this.renderGuildHall();
                }
                else if (phase === 'LEDGER') {
                    document.getElementById('screen-evening').classList.add('active');
                    this.renderLedger();
                }
            },

            updateHUD() {
                document.getElementById('hud-day').innerText = window.GameState.day;
                document.getElementById('hud-gold').innerText = window.GameState.gold;
                document.getElementById('hud-rep').innerText = window.GameState.reputation.town;

                // Crown Rep with warning color
                const crownRep = window.GameState.reputation.crown;
                const crownElement = document.getElementById('hud-crown-rep');
                crownElement.innerText = crownRep;
                if (crownRep <= 0) {
                    crownElement.style.color = '#ff4444';
                } else if (crownRep <= 3) {
                    crownElement.style.color = '#ff8800';
                } else {
                    crownElement.style.color = '';
                }
            },

            openSettings() {
                document.getElementById('settings-modal').style.display = 'flex';
            },

            closeSettings() {
                document.getElementById('settings-modal').style.display = 'none';
            },

            returnToMainMenu() {
                this.closeSettings();
                // Also close game over modal if open
                document.getElementById('game-over-modal').style.display = 'none';
                document.getElementById('game-hud').style.display = 'none';
                document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
                document.getElementById('screen-main-menu').classList.add('active');

                // Update continue button status
                const hasSave = localStorage.getItem('TGM_Save') !== null;
                const continueBtn = document.getElementById('continue-btn');
                continueBtn.disabled = !hasSave;
                continueBtn.style.opacity = hasSave ? '1' : '0.5';
            },

            showGameOver() {
                // Populate stats
                document.getElementById('game-over-days').innerText = window.GameState.day;
                document.getElementById('game-over-gold').innerText = window.GameState.gold;

                // Hide all screens and show game over
                document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
                document.getElementById('game-hud').style.display = 'none';
                document.getElementById('game-over-modal').style.display = 'flex';

                // Clear save (game over means you lost)
                localStorage.removeItem('TGM_Save');
            },

            showQuestProgressModal(progressData) {
                // Find hero info
                const hero = window.GameState.findHeroById(progressData.heroId);
                const heroName = hero ? hero.name : 'Unknown Hero';

                // Populate modal
                document.getElementById('quest-progress-title').innerText = progressData.title;
                document.getElementById('quest-progress-day').innerText = progressData.progressDay;
                document.getElementById('quest-progress-hero').innerText = heroName;
                document.getElementById('quest-progress-quest').innerText = progressData.questName;
                document.getElementById('quest-progress-description').innerText = progressData.description;

                // Set choice button texts
                document.getElementById('quest-progress-choice-0').innerText = progressData.choices[0].text;
                document.getElementById('quest-progress-choice-1').innerText = progressData.choices[1].text;

                // Show modal
                document.getElementById('quest-progress-modal').style.display = 'flex';
            },

            handleQuestProgress(choiceIndex) {
                const progressData = window.GameState.activeQuestProgress;
                if (!progressData) return;

                const choice = progressData.choices[choiceIndex];
                const effects = choice.effects || {};

                // Find the active quest to record the choice
                const activeQuest = window.GameState.activeQuests.find(q => q.id === progressData.questId);
                if (activeQuest && activeQuest.progressData) {
                    activeQuest.progressData.choices.push({
                        day: progressData.progressDay,
                        choiceIndex: choiceIndex,
                        effects: effects
                    });

                    // Apply success modifiers
                    if (effects.successMod) {
                        activeQuest.progressData.modifiers.push({ type: 'success', value: effects.successMod });
                    }
                    if (effects.successModWithFlag) {
                        const flags = window.ChoiceEventSystem?.storyFlags || {};
                        if (flags[effects.successModWithFlag.flag]) {
                            activeQuest.progressData.modifiers.push({ type: 'success', value: effects.successModWithFlag.bonus });
                        }
                    }
                }

                // Apply immediate reputation effects
                if (effects.townRep) {
                    window.GameState.reputation.town = Math.max(0, window.GameState.reputation.town + effects.townRep);
                }
                if (effects.crownRep) {
                    window.GameState.reputation.crown += effects.crownRep;
                }

                // Set story flags
                if (effects.addFlag) {
                    window.ChoiceEventSystem.storyFlags[effects.addFlag] = true;
                }
                if (effects.addFlag2) {
                    window.ChoiceEventSystem.storyFlags[effects.addFlag2] = true;
                }

                // Clear the progress event
                window.GameState.activeQuestProgress = null;
                window.GameState.saveGame();

                // Hide modal and continue to Town Hall
                document.getElementById('quest-progress-modal').style.display = 'none';
                this.updateHUD();
                window.GameState.enterTownHall();
                this.syncScreen();
            },

            showVisitorModal(eventData) {
                document.getElementById('visitor-modal').style.display = 'flex';
                document.getElementById('visitor-name').innerText = eventData.name;
                document.getElementById('visitor-text').innerText = eventData.text;
                document.getElementById('visitor-cost').innerText = eventData.cost;
            },

            handleVisitor(didPay) {
                // Clear the event
                window.GameState.morningEvent = null;

                // Apply payment and log expense
                if (didPay) {
                    window.GameState.gold -= 20;
                    window.GameState.dailyLog.expenses.push({ source: 'Protection Fee', amount: 20 });
                } else {
                    // Could reduce reputation here in future
                    window.GameState.reputation.town = Math.max(0, window.GameState.reputation.town - 1);
                }

                window.GameState.saveGame();

                // Hide modal and immediately go to Town Hall
                document.getElementById('visitor-modal').style.display = 'none';
                window.GameState.enterTownHall();
                this.syncScreen();
            },

            // === CHOICE EVENT SYSTEM (Reigns-style) ===

            showChoiceEventModal(event) {
                document.getElementById('choice-event-modal').style.display = 'flex';
                document.getElementById('choice-event-title').innerText = event.title;
                document.getElementById('choice-event-description').innerText = event.description;
                document.getElementById('choice-text-0').innerText = event.choices[0].text;
                document.getElementById('choice-text-1').innerText = event.choices[1].text;

                // Update button styles based on effects (visual hints)
                const btn0 = document.getElementById('choice-btn-0');
                const btn1 = document.getElementById('choice-btn-1');

                // Add effect hints below button text
                const formatEffects = (effects) => {
                    const hints = [];
                    if (effects.gold > 0) hints.push(`+${effects.gold}G`);
                    if (effects.gold < 0) hints.push(`${effects.gold}G`);
                    if (effects.townRep > 0) hints.push(`+${effects.townRep} Town Rep`);
                    if (effects.townRep < 0) hints.push(`${effects.townRep} Town Rep`);
                    if (effects.crownRep > 0) hints.push(`+${effects.crownRep} Crown Rep`);
                    if (effects.crownRep < 0) hints.push(`${effects.crownRep} Crown Rep`);
                    return hints.length > 0 ? `<div style="font-size:0.8rem; color:#ccc; margin-top:5px;">${hints.join(' ‚Ä¢ ')}</div>` : '';
                };

                document.getElementById('choice-text-0').innerHTML =
                    event.choices[0].text + formatEffects(event.choices[0].effects || {});
                document.getElementById('choice-text-1').innerHTML =
                    event.choices[1].text + formatEffects(event.choices[1].effects || {});
            },

            handleChoiceEvent(choiceIndex) {
                const result = window.ChoiceEventSystem.applyChoice(choiceIndex, window.GameState);

                // Hide modal
                document.getElementById('choice-event-modal').style.display = 'none';

                // Update HUD to reflect changes
                this.updateHUD();

                // Continue with the current phase
                // If we're in MORNING phase, proceed to Town Hall
                if (window.GameState.phase === 'MORNING') {
                    window.GameState.enterTownHall();
                    this.syncScreen();
                }
            },

            checkForPhaseChoiceEvent(phase) {
                if (!window.ChoiceEventSystem) return false;

                const event = window.ChoiceEventSystem.checkForEvent(phase, window.GameState);
                if (event) {
                    this.showChoiceEventModal(event);
                    return true;
                }
                return false;
            },

            // === DEATH MATTERS - VIGIL HANDLING ===

            handleVigil(heroId, holdVigil) {
                let result;
                if (holdVigil) {
                    result = window.GameState.holdVigil(heroId);
                } else {
                    result = window.GameState.skipVigil(heroId);
                }

                // Re-render ledger to reflect changes
                this.renderLedger();
                this.updateHUD();
            },

            goToTownHall() {
                window.GameState.enterTownHall();
                this.syncScreen();
            },

            goToDesk() {
                window.GameState.enterDesk();
                this.syncScreen();
            },

            skipToRoster() {
                window.GameState.enterGuildHall();
                this.syncScreen();
            },

            returnToGuild() {
                window.GameState.enterGuildHall();
                this.syncScreen();
            },

            endDay() {
                const results = window.GameState.endDay();

                // Check for Game Over condition
                if (results.gameOver) {
                    this.showGameOver();
                    return;
                }

                this.syncScreen();
            },

            startNextDay() {
                window.GameState.nextDay();
                this.syncScreen();
            },

            // --- RENDERING ---

            // === DESK VIEW (Queue-based Hiring) ===
            renderDesk() {
                this.updateHUD();
                const hires = window.GameState.availableHires;
                const idx = window.GameState.deskQueueIndex || 0;
                const remaining = hires.length - idx;

                // Update queue counter
                document.getElementById('desk-queue-count').innerText = remaining;

                // Queue dots
                const dotsContainer = document.getElementById('desk-queue-dots');
                dotsContainer.innerHTML = hires.map((_, i) =>
                    `<div style="width:12px; height:12px; border-radius:50%; background:${i === idx ? 'var(--gold)' : '#555'}; border:2px solid var(--wood-dark);"></div>`
                ).join('');

                // Show/hide skip button
                const skipBtn = document.getElementById('skip-to-roster-btn');
                skipBtn.disabled = false;
                skipBtn.style.opacity = '1';

                if (remaining <= 0 || idx >= hires.length) {
                    // No more adventurers - hide card AND speech bubble
                    document.getElementById('desk-adventurer-card').style.display = 'none';
                    document.getElementById('desk-speech-bubble').style.display = 'none';
                    document.getElementById('desk-empty-message').style.display = 'block';
                    return;
                }

                // Show adventurer card and speech bubble
                document.getElementById('desk-adventurer-card').style.display = 'block';
                document.getElementById('desk-speech-bubble').style.display = 'block';
                document.getElementById('desk-empty-message').style.display = 'none';

                const char = hires[idx];

                // Random greeting from dialogue pool
                const greetings = window.GAME_DATA?.adventurerGreetings || ['"..."'];
                const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
                document.getElementById('desk-adventurer-greeting').innerText = `"${randomGreeting}"`;

                // Name & Class
                document.getElementById('desk-char-name').innerText = `${char.name} ${char.surname || ''}`;
                document.getElementById('desk-char-class').innerText = char.className || 'Adventurer';
                document.getElementById('desk-char-level').innerText = `Level ${char.level}`;

                // Visual Tells (flavor text)
                const tells = char.visualTells || [];
                document.getElementById('desk-visual-tells').innerHTML = tells.length > 0
                    ? tells.join(' ‚Ä¢ ')
                    : '<em>Nothing unusual...</em>';

                // Stats (compact inline boxes)
                const stats = char.baseStats || {};
                document.getElementById('desk-char-stats').innerHTML = Object.entries(stats).map(([key, val]) => {
                    const pct = (val / 10) * 100;
                    return `
                        <div style="flex:1; background:#2a2a2a; padding:4px 6px; border-radius:3px; text-align:center;">
                            <div style="font-size:0.6rem; color:#888; text-transform:uppercase;">${key}</div>
                            <div style="font-size:0.85rem; font-weight:bold; color:var(--gold);">${val}</div>
                        </div>
                    `;
                }).join('');

                // Traits (smaller badges)
                const allTraits = [
                    ...(char.traits || []),
                    ...(char.cursedTraits || []).map(t => `‚ö†Ô∏è${t}`),
                    ...(char.legendaryTraits || []).map(t => `‚≠ê${t}`)
                ];
                document.getElementById('desk-char-traits').innerHTML = allTraits.length > 0
                    ? allTraits.map(t => `<span style="background:var(--wood-light); padding:2px 5px; border-radius:2px; margin-right:3px; font-size:0.7rem;">${t}</span>`).join('')
                    : '';

                // Costs
                const fullCost = char.hireCost || 100;
                const freelanceCost = Math.floor(fullCost * 0.4);
                const wage = char.dailyWage || 10;

                document.getElementById('desk-cost-fulltime').innerText = `${fullCost}G`;
                document.getElementById('desk-cost-freelance').innerText = `${freelanceCost}G`;
                document.getElementById('desk-wage').innerText = wage;
            },

            hireFromDesk(hireType) {
                const hires = window.GameState.availableHires;
                const idx = window.GameState.deskQueueIndex || 0;

                if (idx >= hires.length) return;

                const char = hires[idx];
                const result = window.GameState.hireAdventurer(char.id, hireType);

                if (result.success) {
                    // Advance queue (character was removed from availableHires by hireAdventurer)
                    // Note: hireAdventurer removes from availableHires, so index stays same
                    this.updateHUD();
                    this.renderDesk();
                } else {
                    alert(result.message);
                }
            },

            rejectFromDesk() {
                const hires = window.GameState.availableHires;
                const idx = window.GameState.deskQueueIndex || 0;

                if (idx >= hires.length) {
                    this.renderDesk();
                    return;
                }

                // Just advance the index (adventurer stays in pool for potential later appearance)
                window.GameState.deskQueueIndex = idx + 1;
                window.GameState.saveGame();
                this.renderDesk();
            },

            renderTownHall() {
                const container = document.getElementById('town-hall-board');
                container.innerHTML = '';
                const claimedIds = window.GameState.claimedQuests.map(q => q.id);

                window.GameState.availableQuests.forEach(q => {
                    const isClaimed = claimedIds.includes(q.id);
                    const div = document.createElement('div');
                    div.className = 'quest-scroll';

                    // Story quest styling
                    const isStory = q.isStoryQuest || false;
                    const storyBorder = isStory ? 'border-left: 5px solid #8b0000;' : '';
                    const storyIcon = isStory && q.storyIcon ? q.storyIcon + ' ' : '';

                    const rankColor = q.rank === 'S' ? '#9C27B0' : q.rank === 'A' ? '#F44336' : '#4CAF50';

                    // Requirements display (handle both formats)
                    const reqDisplay = q.requirements?.primary ||
                        (q.requirements?.stat ? `${q.requirements.stat.toUpperCase()} ${q.requirements.min}` : 'None');

                    // Description for story quests
                    const descDisplay = isStory && q.description ?
                        `<p style="font-size:0.85rem; color:#666; margin:8px 0;">${q.description}</p>` : '';

                    div.style.cssText = storyBorder;
                    div.innerHTML = `
                        <div class="rank-badge" style="background:${rankColor}">${q.rank}</div>
                        <h3>${storyIcon}${q.name}</h3>
                        <p style="font-style:italic; font-size:0.9rem;">"${q.type} - ${q.duration} Days"</p>
                        ${descDisplay}
                        <hr style="border:0; border-bottom:1px solid #ccc;">
                        <p><strong>Req:</strong> ${reqDisplay}</p>
                        <p><strong>Reward:</strong> <span style="color:var(--green); font-weight:bold;">${q.rewards.gold} G</span></p>
                        <div style="margin-top:auto; text-align:center; padding-top:20px;">
                            <button class="btn" onclick="UI.claimQuest('${q.id}')">${isStory ? 'ü©∏ Accept Quest' : 'Claim Quest'}</button>
                        </div>
                    `;
                    container.appendChild(div);
                });

                document.getElementById('claimed-count').innerText = window.GameState.claimedQuests.length;
            },

            renderGuildHall() {
                document.getElementById('guild-gold').innerText = window.GameState.gold + " G";
                this.updateHUD(); // Keep HUD in sync

                // Combine roster + freelancers for display
                const allHeroes = [
                    ...window.GameState.roster.map(c => ({ ...c, hireCategory: 'Full-Time' })),
                    ...window.GameState.freelancers.map(c => ({ ...c, hireCategory: 'Freelance' }))
                ];

                // Roster
                const rosterList = document.getElementById('guild-roster-list');
                rosterList.innerHTML = '';
                if (allHeroes.length === 0) rosterList.innerHTML = "<em>No heroes. Hire some!</em>";

                allHeroes.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'char-card';
                    div.style.cursor = 'pointer';
                    div.onclick = () => UI.showCharacterModal(c);

                    // Hire type badge
                    const hireBadge = c.hireCategory === 'Freelance' ?
                        '<span style="background:#d4af37; color:#000; padding:2px 6px; border-radius:3px; font-size:0.7rem; font-weight:bold;">FREELANCE</span>' :
                        '<span style="background:#4CAF50; color:#fff; padding:2px 6px; border-radius:3px; font-size:0.7rem; font-weight:bold;">FULL-TIME</span>';

                    // Status badge (enhanced for injuries)
                    let statusBadge = '';
                    const isAssigned = window.GameState.isHeroAssigned(c.id);

                    if (c.status === 'ON_QUEST') {
                        statusBadge = `<br><span style="background:#2196F3; color:#fff; padding:2px 6px; border-radius:3px; font-size:0.65rem;">üó∫Ô∏è ON QUEST (Returns Day ${c.busyUntilDay})</span>`;
                        div.style.opacity = '0.7';
                    } else if (c.status === 'INJURED' && c.injury) {
                        // Show specific injury info
                        const recoveryRemaining = (c.busyUntilDay || 0) - window.GameState.day;
                        const recoveryText = recoveryRemaining > 0 ? `${recoveryRemaining}d rest` : 'Healing';
                        statusBadge = `<br><span style="background:#FF5722; color:#fff; padding:2px 6px; border-radius:3px; font-size:0.65rem;">ü©π ${c.injury.label || 'Injured'} (${recoveryText})</span>`;
                        div.style.opacity = '0.7';
                    } else if (c.status === 'INJURED') {
                        statusBadge = `<br><span style="background:#FF5722; color:#fff; padding:2px 6px; border-radius:3px; font-size:0.65rem;">ü©π INJURED</span>`;
                        div.style.opacity = '0.7';
                    } else if (isAssigned) {
                        statusBadge = `<br><span style="background:#9C27B0; color:#fff; padding:2px 6px; border-radius:3px; font-size:0.65rem;">üìã ASSIGNED</span>`;
                    }

                    // Show scars if any
                    let scarBadge = '';
                    if (c.scars && c.scars.length > 0) {
                        scarBadge = `<br><span style="color:#aa8888; font-size:0.6rem; font-style:italic;">‚öîÔ∏è ${c.scars.map(s => s.label).join(', ')}</span>`;
                    }

                    div.innerHTML = `
                        <div class="char-portrait"></div>
                        <div style="flex:1;">
                            <strong>${c.name}</strong> ${hireBadge}<br>
                            <span style="font-size:0.8rem">Lvl ${c.level || 1} ${c.className || 'Adventurer'}</span>
                            ${statusBadge}
                            ${scarBadge}
                        </div>
                    `;
                    rosterList.appendChild(div);
                });

                // === WALL OF THE FALLEN MEMORIAL ===
                const memorialContainer = document.getElementById('guild-memorial');
                const memorialList = document.getElementById('guild-memorial-list');

                if (window.GameState.memorial && window.GameState.memorial.length > 0) {
                    memorialContainer.style.display = 'block';
                    memorialList.innerHTML = '';

                    window.GameState.memorial.forEach(fallen => {
                        const div = document.createElement('div');
                        div.style.cssText = 'padding:8px; margin:6px 0; background:rgba(139,0,0,0.2); border-left:2px solid #8b0000; font-size:0.8rem;';

                        const vigilIcon = fallen.vigilHeld ? 'üïØÔ∏è' : '‚ö∞Ô∏è';

                        div.innerHTML = `
                            <strong style="color:#ffcdd2;">${vigilIcon} ${fallen.heroName}</strong>
                            <div style="color:#888; font-size:0.7rem;">${fallen.className} ‚Ä¢ Fell on Day ${fallen.deathDay}</div>
                            <div style="color:#666; font-size:0.65rem; font-style:italic; margin-top:3px;">"${fallen.questName}"</div>
                        `;
                        memorialList.appendChild(div);
                    });
                } else {
                    memorialContainer.style.display = 'none';
                }

                // Recruits are now handled in DESK VIEW - no longer render here

                // Claimed Quests (with assignment UI)
                const questList = document.getElementById('guild-quest-list');
                questList.innerHTML = '';
                questList.style.display = 'flex';
                questList.style.flexWrap = 'wrap';
                questList.style.gap = '12px';
                questList.style.alignItems = 'flex-start';

                // Show active quests in progress (compact inline)
                window.GameState.activeQuests.forEach(q => {
                    const hero = window.GameState.findHeroById(q.assignedHeroId);
                    const div = document.createElement('div');
                    div.style.cssText = 'background: rgba(33, 150, 243, 0.15); padding: 10px 14px; border-radius: 6px; border-left: 3px solid #2196F3; min-width:180px;';
                    div.innerHTML = `
                        <div style="font-size:0.85rem; font-weight:bold; color:#2196F3;">üó∫Ô∏è ${q.name}</div>
                        <div style="font-size:0.75rem; color:#aaa; margin-top:4px;">${hero ? hero.name : '?'} ‚Ä¢ Day ${q.returnDay}</div>
                    `;
                    questList.appendChild(div);
                });

                // Show claimed quests awaiting assignment (compact cards)
                window.GameState.claimedQuests.forEach(q => {
                    const div = document.createElement('div');
                    div.style.cssText = 'background: var(--parchment); padding: 12px 14px; border-radius: 6px; border: 2px solid var(--wood-dark); min-width:200px; max-width:240px;';

                    const assigned = q.assignedHeroId ? allHeroes.find(h => h.id === q.assignedHeroId) : null;
                    const duration = parseInt(q.duration ?? 1);
                    const rankColor = q.rank === 'S' ? '#9C27B0' : q.rank === 'A' ? '#F44336' : q.rank === 'B' ? '#FF9800' : '#4CAF50';

                    let assignmentUI = '';
                    if (assigned) {
                        assignmentUI = `
                            <div style="background:#d4edda; padding:6px; border-radius:3px; margin-top:8px; font-size:0.75rem;">
                                ‚úÖ ${assigned.name} (${UI.calculateMockSuccess(assigned, q)}%)
                            </div>
                            <button class="btn" style="font-size:0.7rem; padding:3px 6px; margin-top:6px; background:#888;" onclick="UI.unassignQuest('${q.id}')">Unassign</button>
                        `;
                    } else {
                        assignmentUI = `<button class="btn btn-green" style="font-size:0.75rem; padding:5px 10px; margin-top:8px; width:100%;" onclick="UI.openAssignModal('${q.id}')">Assign Hero</button>`;
                    }

                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <strong style="font-size:0.9rem; color:var(--ink);">${q.name}</strong>
                            <span style="background:${rankColor}; color:white; padding:2px 6px; border-radius:3px; font-size:0.7rem; font-weight:bold;">${q.rank}</span>
                        </div>
                        <div style="font-size:0.75rem; color:#666; margin-top:4px;">${q.rewards.gold}G ‚Ä¢ ${duration} day${duration > 1 ? 's' : ''}</div>
                        ${assignmentUI}
                    `;
                    questList.appendChild(div);
                });

                if (window.GameState.claimedQuests.length === 0 && window.GameState.activeQuests.length === 0) {
                    questList.innerHTML = "<p style='color:#888; font-style:italic;'>No quests claimed. Visit Town Hall!</p>";
                }
            },

            renderLedger() {
                const log = window.GameState.dailyLog;
                const container = document.getElementById('evening-report-content');

                // Update header gold display
                document.getElementById('evening-gold').innerText = window.GameState.gold + ' G';
                this.updateHUD();

                let html = '';


                // === QUEST RESULTS (Rich Narratives) ===
                if (log.questResults && log.questResults.length > 0) {
                    html += `<h4 style="color:var(--ink); font-family:var(--font-display); border-bottom:2px solid var(--ink); padding-bottom:8px;">‚öîÔ∏è Quest Results</h4>`;

                    log.questResults.forEach(result => {
                        // Darker, more professional colors
                        const outcomeStyles = {
                            'LEGENDARY': { bg: '#4a148c', border: '#7b1fa2', text: 'Legendary!' },
                            'GREAT': { bg: '#1b5e20', border: '#2e7d32', text: 'Great Success' },
                            'SUCCESS': { bg: '#33691e', border: '#558b2f', text: 'Success' },
                            'PARTIAL': { bg: '#e65100', border: '#f57c00', text: 'Partial' },
                            'FAILURE': { bg: '#b71c1c', border: '#c62828', text: 'Failed' },
                            'DISASTER': { bg: '#4a0000', border: '#8b0000', text: 'Disaster!' }
                        };
                        const style = outcomeStyles[result.outcome] || outcomeStyles['SUCCESS'];

                        html += `
                            <div style="background:${style.bg}; padding:12px; margin:10px 0; border-radius:6px; border-left:4px solid ${style.border}; color:#fff;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                    <strong style="font-size:1rem; color:#fff;">${result.questName}</strong>
                                    <span style="background:rgba(255,255,255,0.2); color:#fff; padding:3px 10px; border-radius:4px; font-size:0.75rem; font-weight:bold; text-transform:uppercase;">
                                        ${style.text}
                                    </span>
                                </div>
                                <p style="font-style:italic; color:rgba(255,255,255,0.85); margin:8px 0; line-height:1.4; font-size:0.9rem;">"${result.story}"</p>
                                <div style="font-size:0.8rem; color:rgba(255,255,255,0.7); margin-top:8px;">
                                    üßô ${result.heroName} ‚Ä¢ üìä ${result.successRate}% chance
                                    ${result.goldEarned > 0 ? ` ‚Ä¢ <span style="color:#ffd54f; font-weight:bold;">+${result.goldEarned}G</span>` : ''}
                                    ${result.freelancerCut > 0 ? ` ‚Ä¢ <span style="color:#ff8a80;">-${result.freelancerCut}G cut</span>` : ''}
                                </div>
                                ${result.died ? `<div style="color:#ffcdd2; font-weight:bold; margin-top:8px; padding:5px; background:rgba(0,0,0,0.3); border-radius:4px;">üíÄ ${result.heroName} has fallen...</div>` : ''}
                                ${result.injury ? `<div style="color:#ffe0b2; margin-top:8px;">ü©π Injured: ${result.injury.label} (${result.recoveryDays} days recovery)</div>` : ''}
                                ${result.specialEvents && result.specialEvents.length > 0 ?
                                `<div style="color:#b3e5fc; margin-top:8px; font-size:0.85rem;">‚ú® ${result.specialEvents.map(e => e.text).join(' ')}</div>` : ''}
                            </div>
                            ${result.travelEvents && result.travelEvents.length > 0 && window.NarrativeGenerator ?
                                window.NarrativeGenerator.formatTravelEventsHTML(result.travelEvents, result.heroName) : ''}
                            ${result.combatLog && window.NarrativeGenerator ?
                                window.NarrativeGenerator.formatCombatLogHTML(result.combatLog, result.questName) : ''}
                        `;
                    });
                } else {
                    html += `<p style="color:var(--ink); font-style:italic;">No quests completed today.</p>`;
                }

                // === VIGIL CHOICES (Death Matters) ===
                const pendingVigils = window.GameState.dailyLog.pendingVigils || [];
                if (pendingVigils.length > 0) {
                    html += `
                        <div style="margin:20px 0; padding:15px; background:linear-gradient(135deg, #1a0a0a 0%, #2d1515 100%); border:2px solid #8b0000; border-radius:8px;">
                            <h4 style="color:#ff4444; margin:0 0 15px 0; font-family: var(--font-display);">üíÄ The Fallen</h4>
                    `;

                    pendingVigils.forEach(vigil => {
                        html += `
                            <div style="background:rgba(0,0,0,0.4); padding:12px; border-radius:6px; margin-bottom:10px; border-left:3px solid #8b0000;">
                                <p style="color:#ffcdd2; font-weight:bold; margin:0 0 8px 0;">${vigil.heroName} - ${vigil.className} (Level ${vigil.level})</p>
                                <p style="color:#888; font-size:0.85rem; font-style:italic; margin:0 0 12px 0;">${vigil.howDied}</p>
                                <div style="display:flex; gap:10px;">
                                    <button class="btn" style="background:linear-gradient(to bottom, #5c4033, #3d2b23); color:#ffd700; border:1px solid #8b7355; padding:8px 16px;" 
                                        onclick="UI.handleVigil('${vigil.heroId}', true)">
                                        üïØÔ∏è Hold Vigil (-50G, +5 Rep)
                                    </button>
                                    <button class="btn" style="background:#333; color:#888; border:1px solid #555; padding:8px 16px;" 
                                        onclick="UI.handleVigil('${vigil.heroId}', false)">
                                        Lay to Rest (No Ceremony)
                                    </button>
                                </div>
                            </div>
                        `;
                    });

                    html += `</div>`;
                }

                // === ADVENTURE MAP (Active Quests In Progress) ===
                if (window.GameState.activeQuests && window.GameState.activeQuests.length > 0) {
                    html += '<div style="margin-top: 25px;">'; // Add spacing to prevent overlap
                    html += window.QuestMap.render(
                        window.GameState.activeQuests,
                        window.GameState,
                        window.GameState.day
                    );
                    html += '</div>'; // Close spacing div
                }

                // === FINANCIAL SUMMARY ===
                html += `<hr style="border:0; border-top:1px solid #444; margin:20px 0;">`;
                html += `<h4>üí∞ Financial Summary</h4>`;

                html += `<div style="display:flex; gap:20px;">`;

                // Income column
                html += `<div style="flex:1;"><strong style="color:#4CAF50;">Income</strong><ul style="margin:5px 0; padding-left:20px;">`;
                let totalIncome = 0;
                log.income.forEach(item => {
                    html += `<li style="color:#8BC34A;">+${item.amount}G <span style="color:#888; font-size:0.85rem;">${item.source}</span></li>`;
                    totalIncome += item.amount;
                });
                if (log.income.length === 0) html += "<li style='color:#666;'>None</li>";
                html += `</ul></div>`;

                // Expenses column
                html += `<div style="flex:1;"><strong style="color:#F44336;">Expenses</strong><ul style="margin:5px 0; padding-left:20px;">`;
                let totalExp = 0;
                log.expenses.forEach(item => {
                    html += `<li style="color:#ef5350;">-${item.amount}G <span style="color:#888; font-size:0.85rem;">${item.source}</span></li>`;
                    totalExp += item.amount;
                });
                html += `</ul></div>`;

                html += `</div>`;

                // Net total
                const net = totalIncome - totalExp;
                const netColor = net >= 0 ? '#4CAF50' : '#F44336';
                const netSign = net >= 0 ? '+' : '';
                html += `<hr style="border:0; border-top:1px solid #444; margin:15px 0;">`;
                html += `<h3 style="text-align:center;">Net: <span style="color:${netColor}; font-size:1.3rem;">${netSign}${net} G</span></h3>`;

                container.innerHTML = html;
            },

            // --- CHARACTER DETAIL MODAL ---

            showCharacterModal(char) {
                document.getElementById('char-modal-name').innerText = char.name;
                document.getElementById('char-modal-class').innerText = `Class: ${char.className || 'Adventurer'}`;
                document.getElementById('char-modal-level').innerText = `Level ${char.level || 1}`;
                document.getElementById('char-modal-type').innerText = char.hireCategory ? `Hired as: ${char.hireCategory}` : '';

                // Stats
                const stats = char.baseStats || { str: 5, int: 5, dex: 5, vit: 5 };
                let statsHTML = '';
                for (let [stat, value] of Object.entries(stats)) {
                    const barFill = Math.round((value / 10) * 100);
                    const statLabel = stat.toUpperCase();
                    statsHTML += `
                        <div style="margin-bottom:8px;">
                            <span style="display:inline-block; width:35px; font-weight:bold;">${statLabel}:</span>
                            <div style="display:inline-block; width:150px; height:12px; background:#ddd; border:1px solid #999; vertical-align:middle;">
                                <div style="width:${barFill}%; height:100%; background:#4CAF50;"></div>
                            </div>
                            <span style="margin-left:8px;">${value}</span>
                        </div>
                    `;
                }
                document.getElementById('char-modal-stats').innerHTML = statsHTML;

                // Traits
                const traits = char.traits || [];
                let traitsHTML = '';
                if (traits.length === 0) {
                    traitsHTML = '<em>No special traits.</em>';
                } else {
                    traits.forEach(trait => {
                        traitsHTML += `<div style="background:#f5f5f5; padding:6px; margin-bottom:5px; border-left:3px solid var(--gold);"><strong>${trait.name || trait}</strong></div>`;
                    });
                }
                document.getElementById('char-modal-traits').innerHTML = traitsHTML;

                document.getElementById('character-modal').style.display = 'flex';
            },

            closeCharacterModal() {
                document.getElementById('character-modal').style.display = 'none';
            },

            // --- QUEST ASSIGNMENT ---

            openAssignModal(questId) {
                const quest = window.GameState.claimedQuests.find(q => q.id === questId);
                if (!quest) return;

                this.currentAssignQuestId = questId;
                document.getElementById('assign-quest-name').innerText = quest.name;

                const duration = parseInt(quest.duration ?? 1);
                const rankColor = quest.rank === 'S' ? '#9C27B0' : quest.rank === 'A' ? '#F44336' : quest.rank === 'B' ? '#FF9800' : '#4CAF50';

                // Combine roster + freelancers
                const allHeroes = [
                    ...window.GameState.roster,
                    ...window.GameState.freelancers
                ];

                const heroList = document.getElementById('assign-hero-list');
                heroList.innerHTML = '';

                // Show detailed quest info panel
                const reqStat = quest.requirements?.stat?.toUpperCase() || quest.requirements?.primary || 'STR';
                const reqMin = quest.requirements?.min || 5;
                heroList.innerHTML = `
                    <div style="background: linear-gradient(135deg, #f5f0e6 0%, #ebe5d8 100%); padding:12px; border-radius:6px; margin-bottom:15px; border-left:4px solid ${rankColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span style="background:${rankColor}; color:white; padding:3px 10px; border-radius:4px; font-size:0.8rem; font-weight:bold;">Rank ${quest.rank}</span>
                            <span style="font-size:0.85rem; color:#555;">üìÖ ${duration} day${duration > 1 ? 's' : ''} ‚Üí Returns Day ${window.GameState.day + duration}</span>
                        </div>
                        <div style="font-size:0.85rem; color:#444; margin-bottom:6px;">
                            <strong>Type:</strong> ${quest.type || 'Adventure'}
                        </div>
                        <div style="font-size:0.85rem; color:#444; margin-bottom:6px;">
                            <strong>Requires:</strong> ${reqStat} ${reqMin}+ recommended
                        </div>
                        <div style="font-size:0.85rem; color:#444; margin-bottom:6px;">
                            <strong>Reward:</strong> <span style="color:#2e7d32; font-weight:bold;">${quest.rewards?.gold || 50}G</span>
                        </div>
                        ${quest.description ? `<div style="font-size:0.8rem; color:#666; font-style:italic; margin-top:8px; padding-top:8px; border-top:1px solid #ddd;">"${quest.description}"</div>` : ''}
                    </div>
                    <h4 style="margin:0 0 10px 0; font-size:0.95rem; color:var(--ink);">Select Hero:</h4>
                `;

                const availableHeroes = allHeroes.filter(h =>
                    window.GameState.isHeroAvailable(h.id) && !window.GameState.isHeroAssigned(h.id)
                );

                if (availableHeroes.length === 0) {
                    heroList.innerHTML += '<p style="color:#999;">No available heroes. They may be on quests, injured, or already assigned.</p>';
                } else {
                    availableHeroes.forEach(hero => {
                        const successRate = this.calculateMockSuccess(hero, quest);
                        const div = document.createElement('div');
                        div.style.cssText = 'padding:10px; margin:8px 0; background:#f5f5f5; cursor:pointer; border:2px solid transparent; border-radius:4px;';
                        div.onmouseover = () => div.style.borderColor = 'var(--gold)';
                        div.onmouseout = () => div.style.borderColor = 'transparent';
                        div.onclick = () => UI.assignHeroToQuest(hero.id);

                        const typeLabel = hero.hireType === 'freelance' ? ' (Freelance - 50% cut)' : '';
                        div.innerHTML = `
                            <strong>${hero.name}</strong> (Lvl ${hero.level || 1})${typeLabel}<br>
                            <span style="font-size:0.85rem; color:#666;">Est. Success: ${successRate}%</span>
                        `;
                        heroList.appendChild(div);
                    });
                }

                // Show unavailable heroes greyed out
                const unavailableHeroes = allHeroes.filter(h =>
                    !window.GameState.isHeroAvailable(h.id) || window.GameState.isHeroAssigned(h.id)
                );

                if (unavailableHeroes.length > 0) {
                    const unavailHeader = document.createElement('p');
                    unavailHeader.style.cssText = 'color:#999; margin-top:15px; font-size:0.85rem;';
                    unavailHeader.innerText = '‚Äî Unavailable ‚Äî';
                    heroList.appendChild(unavailHeader);

                    unavailableHeroes.forEach(hero => {
                        const div = document.createElement('div');
                        div.style.cssText = 'padding:8px; margin:4px 0; background:#e0e0e0; opacity:0.5; border-radius:4px;';

                        let reason = '';
                        if (hero.status === 'ON_QUEST') reason = `On quest until Day ${hero.busyUntilDay}`;
                        else if (hero.status === 'INJURED') reason = 'Injured';
                        else if (window.GameState.isHeroAssigned(hero.id)) reason = 'Already assigned';

                        div.innerHTML = `<strong>${hero.name}</strong> <span style="color:#999;">(${reason})</span>`;
                        heroList.appendChild(div);
                    });
                }

                document.getElementById('assign-modal').style.display = 'flex';
            },

            closeAssignModal() {
                document.getElementById('assign-modal').style.display = 'none';
            },

            assignHeroToQuest(heroId) {
                const questId = this.currentAssignQuestId;

                // Use GameState's validated method
                const result = window.GameState.assignHeroToQuest(questId, heroId);

                if (result.success) {
                    this.closeAssignModal();
                    this.renderGuildHall();
                } else {
                    alert(result.message);
                }
            },

            unassignQuest(questId) {
                const result = window.GameState.unassignHeroFromQuest(questId);
                if (result.success) {
                    this.renderGuildHall();
                }
            },

            calculateMockSuccess(hero, quest) {
                // Simple mock calculation (will replace with MatchFormula.js later)
                const heroLevel = hero.level || 1;
                const questRankValue = { F: 1, D: 2, C: 3, B: 4, A: 5, S: 6 }[quest.rank] || 1;
                const base = 70;
                const levelBonus = (heroLevel - questRankValue) * 10;
                return Math.max(10, Math.min(95, base + levelBonus));
            },

            // --- ACTIONS ---

            claimQuest(id) {
                const result = window.GameState.claimQuest(id);
                if (result.success) {
                    this.renderTownHall();
                } else {
                    alert(result.message);
                }
            },

            hire(id, hireType = 'fulltime') {
                const result = window.GameState.hireAdventurer(id, hireType);
                if (result.success) {
                    this.renderGuildHall();
                } else {
                    alert(result.message);
                }
            }
        };

        window.onload = () => UI.init();
    </script>
</body>

</html>